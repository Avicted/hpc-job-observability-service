openapi: 3.0.3
info:
  title: HPC Job Observability Service API
  description: |
    A job-level monitoring and observability service for HPC environments.
    This API provides access to job metadata, states, and resource usage metrics.
  version: 1.0.0
  contact:
    name: HPC Observability Team
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

servers:
  - url: http://localhost:8080/v1
    description: Local development server

tags:
  - name: jobs
    description: Job management and metadata
  - name: metrics
    description: Job metrics and resource usage
  - name: health
    description: Service health endpoints

paths:
  /health:
    get:
      tags:
        - health
      summary: Health check
      description: Returns the health status of the service
      operationId: getHealth
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: healthy
                timestamp: '2026-01-20T10:00:00Z'

  /jobs:
    get:
      tags:
        - jobs
      summary: List all jobs
      description: Returns a list of all known jobs with optional filtering
      operationId: listJobs
      parameters:
        - name: state
          in: query
          description: Filter by job state
          required: false
          schema:
            $ref: '#/components/schemas/JobState'
        - name: user
          in: query
          description: Filter by user
          required: false
          schema:
            type: string
            example: user123
        - name: node
          in: query
          description: Filter by node name
          required: false
          schema:
            type: string
            example: node-01
        - name: limit
          in: query
          description: Maximum number of jobs to return
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
        - name: offset
          in: query
          description: Number of jobs to skip for pagination
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of jobs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobListResponse'
              example:
                jobs:
                  - id: job-001
                    user: alice
                    nodes:
                      - node-01
                      - node-02
                    state: running
                    start_time: '2026-01-20T08:00:00Z'
                    cpu_usage: 85.5
                    memory_usage_mb: 4096
                    gpu_usage: 45.0
                  - id: job-002
                    user: bob
                    nodes:
                      - node-03
                    state: completed
                    start_time: '2026-01-19T14:00:00Z'
                    end_time: '2026-01-19T18:30:00Z'
                    runtime_seconds: 16200
                    cpu_usage: 0
                    memory_usage_mb: 0
                total: 2
                limit: 100
                offset: 0
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - jobs
      summary: Create a new job
      description: Register a new job in the system
      operationId: createJob
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateJobRequest'
            example:
              id: job-003
              user: charlie
              nodes:
                - node-04
                - node-05
      parameters:
        - $ref: '#/components/parameters/ChangedByHeader'
        - $ref: '#/components/parameters/SourceHeader'
        - $ref: '#/components/parameters/CorrelationIdHeader'
      responses:
        '201':
          description: Job created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Job'
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Job with this ID already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /jobs/{jobId}:
    get:
      tags:
        - jobs
      summary: Get job details
      description: Returns metadata and current state for a specific job
      operationId: getJob
      parameters:
        - $ref: '#/components/parameters/JobId'
      responses:
        '200':
          description: Job details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Job'
              example:
                id: job-001
                user: alice
                nodes:
                  - node-01
                  - node-02
                state: running
                start_time: '2026-01-20T08:00:00Z'
                cpu_usage: 85.5
                memory_usage_mb: 4096
                gpu_usage: 45.0
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    patch:
      tags:
        - jobs
      summary: Update job
      description: Update job state or metadata
      operationId: updateJob
      parameters:
        - $ref: '#/components/parameters/JobId'
        - $ref: '#/components/parameters/ChangedByHeader'
        - $ref: '#/components/parameters/SourceHeader'
        - $ref: '#/components/parameters/CorrelationIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateJobRequest'
            example:
              state: completed
      responses:
        '200':
          description: Job updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Job'
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - jobs
      summary: Delete job
      description: Remove a job from the system
      operationId: deleteJob
      parameters:
        - $ref: '#/components/parameters/JobId'
        - $ref: '#/components/parameters/ChangedByHeader'
        - $ref: '#/components/parameters/SourceHeader'
        - $ref: '#/components/parameters/CorrelationIdHeader'
      responses:
        '204':
          description: Job deleted successfully
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /jobs/{jobId}/metrics:
    get:
      tags:
        - metrics
      summary: Get job metrics history
      description: Returns historical resource usage metrics for a specific job
      operationId: getJobMetrics
      parameters:
        - $ref: '#/components/parameters/JobId'
        - name: start_time
          in: query
          description: Start of time range (RFC3339 format)
          required: false
          schema:
            type: string
            format: date-time
        - name: end_time
          in: query
          description: End of time range (RFC3339 format)
          required: false
          schema:
            type: string
            format: date-time
        - name: limit
          in: query
          description: Maximum number of samples to return
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 10000
            default: 1000
      responses:
        '200':
          description: Job metrics history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobMetricsResponse'
              example:
                job_id: job-001
                samples:
                  - timestamp: '2026-01-20T08:00:00Z'
                    cpu_usage: 82.3
                    memory_usage_mb: 3980
                    gpu_usage: 42.0
                  - timestamp: '2026-01-20T08:01:00Z'
                    cpu_usage: 85.5
                    memory_usage_mb: 4096
                    gpu_usage: 45.0
                total: 2
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - metrics
      summary: Record job metrics
      description: Submit a new metrics sample for a job
      operationId: recordJobMetrics
      parameters:
        - $ref: '#/components/parameters/JobId'
        - $ref: '#/components/parameters/ChangedByHeader'
        - $ref: '#/components/parameters/SourceHeader'
        - $ref: '#/components/parameters/CorrelationIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RecordMetricsRequest'
            example:
              cpu_usage: 88.2
              memory_usage_mb: 4200
              gpu_usage: 48.5
      responses:
        '201':
          description: Metrics recorded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricSample'
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /events/job-started:
    post:
      tags:
        - events
      summary: Job started event
      description: |
        Receives a job started event from Slurm prolog scripts.
        This event registers a new job with its cgroup path and GPU allocation.
        The endpoint is idempotent - duplicate events are handled safely.
      operationId: jobStartedEvent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobStartedEvent'
            example:
              job_id: "12345"
              user: alice
              node_list:
                - node-01
                - node-02
              cpu_allocation: 16
              gpu_allocation: 2
              gpu_vendor: nvidia
              gpu_devices:
                - GPU-abc123
                - GPU-def456
              cgroup_path: /sys/fs/cgroup/system.slice/slurmstepd.scope/job_12345
              timestamp: '2026-01-22T10:00:00Z'
      responses:
        '200':
          description: Job started event processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobEventResponse'
        '400':
          description: Invalid event payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /events/job-finished:
    post:
      tags:
        - events
      summary: Job finished event
      description: |
        Receives a job finished event from Slurm epilog scripts.
        This event closes the job with its final state and exit code.
        The endpoint is idempotent - duplicate events are handled safely.
      operationId: jobFinishedEvent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobFinishedEvent'
            example:
              job_id: "12345"
              final_state: completed
              exit_code: 0
              timestamp: '2026-01-22T12:30:00Z'
      responses:
        '200':
          description: Job finished event processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobEventResponse'
        '400':
          description: Invalid event payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  parameters:
    JobId:
      name: jobId
      in: path
      description: Unique job identifier
      required: true
      schema:
        type: string
        minLength: 1
        maxLength: 255
      example: job-001
    ChangedByHeader:
      name: X-Changed-By
      in: header
      description: Identifier of the actor/system performing the change
      required: true
      schema:
        type: string
        minLength: 1
    SourceHeader:
      name: X-Source
      in: header
      description: Source system initiating the change (api, syncer, scheduler)
      required: true
      schema:
        type: string
        minLength: 1
    CorrelationIdHeader:
      name: X-Correlation-Id
      in: header
      description: Correlation ID for tracing multi-step updates
      required: false
      schema:
        type: string

  schemas:
    HealthResponse:
      type: object
      required:
        - status
        - timestamp
      properties:
        status:
          type: string
          enum:
            - healthy
            - degraded
            - unhealthy
          description: Current health status of the service
        timestamp:
          type: string
          format: date-time
          description: Time of health check
        version:
          type: string
          description: Service version

    JobState:
      type: string
      enum:
        - pending
        - running
        - completed
        - failed
        - cancelled
      description: Current state of the job

    Job:
      type: object
      required:
        - id
        - user
        - nodes
        - state
        - start_time
      properties:
        id:
          type: string
          description: Unique job identifier
          example: job-001
        user:
          type: string
          description: User who submitted the job
          example: alice
        nodes:
          type: array
          items:
            type: string
          description: List of node names allocated to the job
          example:
            - node-01
            - node-02
        node_count:
          type: integer
          minimum: 0
          description: Number of nodes allocated to the job
        state:
          $ref: '#/components/schemas/JobState'
        start_time:
          type: string
          format: date-time
          description: Job start time
        end_time:
          type: string
          format: date-time
          description: Job end time (if completed or failed)
        runtime_seconds:
          type: number
          format: double
          description: Total runtime in seconds
        cpu_usage:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: Current CPU usage percentage
        memory_usage_mb:
          type: integer
          minimum: 0
          description: Current memory usage in megabytes
        gpu_usage:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: Current GPU usage percentage (optional)
        requested_cpus:
          type: integer
          minimum: 0
          description: CPUs requested by the job
        allocated_cpus:
          type: integer
          minimum: 0
          description: CPUs allocated to the job
        requested_memory_mb:
          type: integer
          minimum: 0
          description: Memory requested by the job (MB)
        allocated_memory_mb:
          type: integer
          minimum: 0
          description: Memory allocated to the job (MB)
        requested_gpus:
          type: integer
          minimum: 0
          description: GPUs requested by the job
        allocated_gpus:
          type: integer
          minimum: 0
          description: GPUs allocated to the job
        cluster_name:
          type: string
          description: Cluster identifier for multi-cluster deployments
        scheduler_instance:
          type: string
          description: Scheduler instance identifier
        ingest_version:
          type: string
          description: Ingestion pipeline version
        last_sample_at:
          type: string
          format: date-time
          description: Timestamp of the latest metrics sample
        sample_count:
          type: integer
          minimum: 0
          description: Total number of metrics samples recorded for the job
        avg_cpu_usage:
          type: number
          format: double
          description: Average CPU usage across samples
        max_cpu_usage:
          type: number
          format: double
          description: Maximum CPU usage across samples
        max_memory_usage_mb:
          type: integer
          minimum: 0
          description: Maximum memory usage across samples (MB)
        avg_gpu_usage:
          type: number
          format: double
          description: Average GPU usage across samples
        max_gpu_usage:
          type: number
          format: double
          description: Maximum GPU usage across samples
        scheduler:
          $ref: '#/components/schemas/SchedulerInfo'

    SchedulerInfo:
      type: object
      description: |
        Metadata from the external workload manager (e.g., SLURM).
        This information is populated when jobs are synced from an external scheduler.
      properties:
        type:
          type: string
          enum:
            - mock
            - slurm
          description: Type of scheduler that manages this job
          example: slurm
        external_job_id:
          type: string
          description: Job ID in the external scheduler (e.g., SLURM job_id)
          example: "12345"
        raw_state:
          type: string
          description: |
            Original state string from the scheduler before normalization.
            For SLURM: PENDING, RUNNING, COMPLETED, FAILED, CANCELLED, TIMEOUT, NODE_FAIL, etc.
          example: COMPLETING
        submit_time:
          type: string
          format: date-time
          description: Time when the job was submitted to the scheduler
        partition:
          type: string
          description: Scheduler partition/queue name
          example: gpu
        account:
          type: string
          description: Account/project charged for the job
          example: project_123
        qos:
          type: string
          description: Quality of Service level
          example: normal
        priority:
          type: integer
          format: int64
          description: Job priority in the scheduler queue (Slurm uses uint32 which may exceed int32)
          example: 100
        exit_code:
          type: integer
          description: Job exit code (available after completion)
          example: 0
        state_reason:
          type: string
          description: Scheduler-provided reason for state transitions
          example: None
        time_limit_minutes:
          type: integer
          description: Time limit in minutes
          example: 60
        extra:
          type: object
          additionalProperties: true
          description: Additional scheduler-specific metadata

    CreateJobRequest:
      type: object
      required:
        - id
        - user
        - nodes
      properties:
        id:
          type: string
          minLength: 1
          maxLength: 255
          description: Unique job identifier
        user:
          type: string
          minLength: 1
          maxLength: 255
          description: User who submitted the job
        nodes:
          type: array
          items:
            type: string
          minItems: 1
          description: List of node names to allocate
        scheduler:
          $ref: '#/components/schemas/SchedulerInfo'

    UpdateJobRequest:
      type: object
      properties:
        state:
          $ref: '#/components/schemas/JobState'
        cpu_usage:
          type: number
          format: double
          minimum: 0
          maximum: 100
        memory_usage_mb:
          type: integer
          minimum: 0
        gpu_usage:
          type: number
          format: double
          minimum: 0
          maximum: 100

    MetricSample:
      type: object
      required:
        - timestamp
        - cpu_usage
        - memory_usage_mb
      properties:
        timestamp:
          type: string
          format: date-time
          description: Time when the sample was recorded
        cpu_usage:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: CPU usage percentage at this point in time
        memory_usage_mb:
          type: integer
          minimum: 0
          description: Memory usage in megabytes at this point in time
        gpu_usage:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: GPU usage percentage at this point in time (optional)

    RecordMetricsRequest:
      type: object
      required:
        - cpu_usage
        - memory_usage_mb
      properties:
        cpu_usage:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: CPU usage percentage
        memory_usage_mb:
          type: integer
          minimum: 0
          description: Memory usage in megabytes
        gpu_usage:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: GPU usage percentage (optional)

    JobListResponse:
      type: object
      required:
        - jobs
        - total
        - limit
        - offset
      properties:
        jobs:
          type: array
          items:
            $ref: '#/components/schemas/Job'
        total:
          type: integer
          description: Total number of jobs matching the filter
        limit:
          type: integer
          description: Maximum number of jobs returned
        offset:
          type: integer
          description: Number of jobs skipped

    JobMetricsResponse:
      type: object
      required:
        - job_id
        - samples
        - total
      properties:
        job_id:
          type: string
          description: Job identifier
        samples:
          type: array
          items:
            $ref: '#/components/schemas/MetricSample'
        total:
          type: integer
          description: Total number of samples returned

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error code
          example: not_found
        message:
          type: string
          description: Human-readable error message
          example: Job with ID 'job-999' not found
        details:
          type: object
          additionalProperties: true
          description: Additional error details

    GPUVendor:
      type: string
      enum:
        - none
        - nvidia
        - amd
        - mixed
      description: GPU vendor type

    JobStartedEvent:
      type: object
      required:
        - job_id
        - user
        - node_list
        - timestamp
      description: Event emitted by Slurm prolog script when a job starts
      properties:
        job_id:
          type: string
          description: Slurm job ID
          example: "12345"
        user:
          type: string
          description: User who submitted the job
          example: alice
        node_list:
          type: array
          items:
            type: string
          description: List of nodes allocated to the job
          example:
            - node-01
            - node-02
        cpu_allocation:
          type: integer
          minimum: 0
          description: Number of CPUs allocated
          example: 16
        memory_allocation_mb:
          type: integer
          minimum: 0
          description: Memory allocated in MB
          example: 65536
        gpu_allocation:
          type: integer
          minimum: 0
          description: Number of GPUs allocated
          example: 2
        gpu_vendor:
          $ref: '#/components/schemas/GPUVendor'
        gpu_devices:
          type: array
          items:
            type: string
          description: GPU device identifiers (UUIDs or card IDs)
          example:
            - GPU-abc123
            - GPU-def456
        cgroup_path:
          type: string
          description: Path to the job's cgroup
          example: /sys/fs/cgroup/system.slice/slurmstepd.scope/job_12345
        partition:
          type: string
          description: Slurm partition name
          example: gpu
        account:
          type: string
          description: Slurm account name
          example: project_123
        timestamp:
          type: string
          format: date-time
          description: Event timestamp

    JobFinishedEvent:
      type: object
      required:
        - job_id
        - final_state
        - timestamp
      description: Event emitted by Slurm epilog script when a job finishes
      properties:
        job_id:
          type: string
          description: Slurm job ID
          example: "12345"
        final_state:
          $ref: '#/components/schemas/JobState'
        exit_code:
          type: integer
          description: Job exit code
          example: 0
        signal:
          type: integer
          description: Signal that killed the job (if applicable)
          example: 9
        timestamp:
          type: string
          format: date-time
          description: Event timestamp

    JobEventResponse:
      type: object
      required:
        - status
        - job_id
      properties:
        status:
          type: string
          enum:
            - created
            - updated
            - skipped
          description: Result of processing the event
        job_id:
          type: string
          description: Job identifier
        message:
          type: string
          description: Optional message with details
